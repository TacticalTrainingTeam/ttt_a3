name: Upload Release

on:
  release:
    types: [ "published" ]

env:
  # Define minimal addons list - easily editable for future PRs
  MINIMAL_ADDONS: >-
    main
    common
    clearhud
    chatcommands
    discord_richpresence
    fsml
    mpls
    no_chain
    screenshotmode
    signs
    spotlight_event
    teleport
    w_teleporter

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the source code
      uses: actions/checkout@v6

    - name: Setup HEMTT
      uses: arma-actions/hemtt@v1

    # Build full version
    - name: Build TTT Mod Full Release
      run: hemtt release

    - name: Rename full release
      run: mv releases/ttt-latest.zip releases/ttt-full-latest.zip

    # Build minimal version
    - name: Checkout the source code again for minimal build
      uses: actions/checkout@v6
      with:
        path: minimal-build

    - name: Remove non-minimal addons
      working-directory: minimal-build
      run: |
        # Convert space-separated addon list to array
        KEEP_ADDONS="${{ env.MINIMAL_ADDONS }}"

        # Find all addon directories
        cd addons
        for dir in */; do
          addon_name="${dir%/}"
          should_keep=false

          # Check if this addon should be kept
          for keep in $KEEP_ADDONS; do
            if [ "$addon_name" = "$keep" ]; then
              should_keep=true
              break
            fi
          done

          # Remove if not in the keep list
          if [ "$should_keep" = "false" ]; then
            echo "Removing addon: $addon_name"
            rm -rf "$addon_name"
          else
            echo "Keeping addon: $addon_name"
          fi
        done

    - name: Build TTT Mod Minimal Release
      working-directory: minimal-build
      run: hemtt release

    - name: Copy minimal release to main releases folder
      run: cp minimal-build/releases/ttt-latest.zip releases/ttt-minimal-latest.zip

    # Upload both versions to release
    - name: Upload full version to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: releases/ttt-full-latest.zip
        asset_name: ttt-full-$tag.zip
        tag: ${{ github.ref }}
        overwrite: true

    - name: Upload minimal version to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: releases/ttt-minimal-latest.zip
        asset_name: ttt-minimal-$tag.zip
        tag: ${{ github.ref }}
        overwrite: true
